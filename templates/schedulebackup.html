<!DOCTYPE html>
<html>
<head>
    <title>Bowling Lane Schedule</title>

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
	
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>


    <style>
        table {
            border-collapse: collapse;
        }

        td, th {
            border: 1px solid black;
            padding: 8px;
        }

        th {
            background-color: #f0f0f0;
        }

        td {
            text-align: center;
            vertical-align: middle;
        }

        td.reservation {
            background-color: #00008f;
            color: white;
        }

        .defective-label {
            color: red;
        }

        .ok-label {
            color: green;
        }

        .defective-row td:not(:first-child) {
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 5px,
                black 6px,
                black 7px
            );
            color: red;
            font-weight: bold;
        }
        
        .datebuttons {
			display: inline-block;
			margin-bottom: 20px;
		}

    </style>
</head>
<body>
    <h1>Bowling Lane Schedule for {{ requested_date.strftime('%A, %d. %B %Y') }}</h1>
    
    <form class="datebuttons" action="{{ url_for('display_schedule', date=prev_date) }}">
    <input type="submit" value="<<<">
	</form>
	<form class="datebuttons" action="/">
    <input type="submit" value="Today">
	</form>
	<form class="datebuttons" action="{{ url_for('display_schedule', date=next_date) }}">
    <input type="submit" value=">>>">
	</form>
	
<form class="datebuttons" action="{{ url_for('display_schedule') }}" method="GET">
    <label for="datepicker" class="calendar-icon">
        <i class="fas fa-calendar-alt" onclick="$('#datepicker').datepicker('show');"></i>
    </label>
    <input type="text" id="datepicker" name="selected_date">
    <input type="submit" value="Show Reservations">
</form>
	

    <table>
        <tr>
            <th></th>
            {% for time_slot in time_slots %}
                <th>{{ "%02d:%02d" % ((time_slot // 60) % 24, time_slot % 60) }}</th>
            {% endfor %}
        </tr>
        {% for lane in range(num_lanes) %}
            <tr data-lane="{{ lane + 1}}">
				<td>
					<strong>Lane {{ lane + 1 }}</strong><br>
					<label class="ok-label">
						<input type="radio" id="lane_status_{{ lane + 1 }}_ok" name="lane_status_{{ lane + 1 }}" value="ok" {% if not lane_defective_states[lane] %}checked{% endif %}> OK
					</label>
					<label class="defective-label">
						<input type="radio" id="lane_status_{{ lane + 1 }}_defective" name="lane_status_{{ lane + 1 }}" value="defective" {% if lane_defective_states[lane] %}checked{% endif %}> Defective
					</label>
				</td>
                {% for time_slot in time_slots %}
                    {% if lane_reservations[lane][time_slot] %}
                        {% if lane_reservations[lane][time_slot] != 'occupied' %}
                            <td colspan={{ lane_reservations[lane][time_slot]['duration_slots'] }} class="reservation">
                                {{ lane_reservations[lane][time_slot]['name'] }}<br>
                                {{ lane_reservations[lane][time_slot]['players'] }} players <br>
                                {% if lane_reservations[lane][time_slot]['kids'] == 1 %}
									with kids <br>
								{% else %}
									without kids <br>
								{% endif %}
								{% if lane_reservations[lane][time_slot]['specialevent'] != "No" %}
									{{ lane_reservations[lane][time_slot]['specialevent'] }}
								{% endif %}
                            </td>
                        {% elif lane_reservations[lane][time_slot] == 'occupied'%}
                        {% else %}
                            <td></td>
                        {% endif %}
                    {% else %}
                        <td></td>
                    {% endif %}
                {% endfor %}
            </tr>
        {% endfor %}
    </table>
    
<script>
    $(function() {
        $("#datepicker").datepicker({
            dateFormat: 'yy-mm-dd', // Format the date as needed
            changeMonth: true,
            changeYear: true,
            // Additional options can be added based on your preferences
        });
    });
</script>
    
<script>
    // JavaScript for radio button event listeners
    const defectiveRadioButtons = document.querySelectorAll('input[value="defective"]');
    defectiveRadioButtons.forEach(button => {
        button.addEventListener('change', function () {
            const row = this.closest('tr');
            const laneNumber = row.dataset.lane; // Get lane number from the row's data attribute

            if (this.checked) {
                row.classList.add('defective-row');
                updateDefectiveState(laneNumber, true);
            } else {
                row.classList.remove('defective-row');
                updateDefectiveState(laneNumber, false);
            }
        });
    });

    const okRadioButtons = document.querySelectorAll('input[value="ok"]');
    okRadioButtons.forEach(button => {
        button.addEventListener('change', function () {
            const row = this.closest('tr');
            const laneNumber = row.dataset.lane; // Get lane number from the row's data attribute

            if (this.checked) {
                row.classList.remove('defective-row');
                updateDefectiveState(laneNumber, false);
            }
        });
    });

    // Additional script to apply formatting on page load
    document.addEventListener('DOMContentLoaded', function () {
        defectiveRadioButtons.forEach(button => {
            const row = button.closest('tr');
            if (button.checked) {
                row.classList.add('defective-row');
            }
        });
    });

    // Function to send AJAX request to update defective state
    function updateDefectiveState(laneNumber, isDefective) {
        $.ajax({
            type: 'POST',
            url: '/update_defective_state',
            data: { laneNumber: laneNumber, isDefective: isDefective.toString() },
            success: function (response) {
                console.log(response); // Log the server response (optional)
            },
            error: function (error) {
                console.error('Error updating defective state:', error);
            }
        });
    }
</script>
</body>
</html>
